# name: $(BuildID)

trigger:
  batch: true
  branches:
    include:
    - feat/pipeline
    - main
  paths:
    exclude:
    - README.md

variables:
  serviceConnectionName: nuxt-ssr-app-test
  startupCommand: node_modules/.bin/nuxt start
  webappName: nuxt-ssr-app-test

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  displayName: Setup Node.js
  inputs:
    versionSpec: '14.x'

- script: npm install --production
  displayName: Install Dependencies

- script: npm run build
  displayName: Build Nuxt App

- task: ArchiveFiles@2
  displayName: Create Zip File
  inputs:
    rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
    includeRootFolder: false
    archiveType: zip
    archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
    replaceExistingArchive: true

- upload: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
  displayName: Upload Zip File
  artifact: drop

- task: AzureWebApp@1
  displayName: Zip Deploy to Azure Web App
  inputs:
    azureSubscription: $(serviceConnectionName)
    appType: webAppLinux
    appName: $(webappName)
    runtimeStack: 'NODE|10.10'
    package: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip # $(Pipeline.Workspace)/drop/$(Build.BuildId).zip
    startUpCommand: $(startupCommand)
